@model IEnumerable<Core.Concretes.DTOs.Sales.CurrentCartItem>

@{
    ViewData["Title"] = "ShoppingCart";
    var total_price = Model.Sum(x => x.Price * x.Quantity);
    var total_discount = Model.Sum(x => (x.Price - x.DiscountedPrice) * x.Quantity);
    var total_due = Model.Sum(x => x.DiscountedPrice * x.Quantity);
}



<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body p-0">
                <h5>ShoppingCart</h5>
                <hr />
                <table class="table table-hover table-striped">
                    <thead>
                        <tr>
                            <th colspan="2">
                                Product
                            </th>
                            <th>
                                @Html.DisplayNameFor(model => model.Quantity)
                            </th>
                            <th>
                                List Price
                            </th>
                            <th>
                                Total Price
                            </th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model)
                        {
                            <tr>
                                <td>
                                    <img src="@item.Thumbnail" alt="@item.Name" class="img-thumbnail" style="height:64px;" />
                                </td>
                                <td>
                                    @Html.DisplayFor(modelItem => item.Name)
                                </td>
                                <td>
                                    <div class="input-group input-group-sm">
                                        <button class="btn btn-outline-secondary" type="button" name="change_qty" data-pid="@item.ProductId" data-direction="decrement" onclick="changeQty(this)">-</button>
                                        <input type="text" disabled class="form-control text-center" placeholder="" value="@item.Quantity" />
                                        <button class="btn btn-outline-secondary" type="button" name="change_qty" data-pid="@item.ProductId" data-direction="increment" onclick="changeQty(this)">+</button>
                                    </div>
                                </td>

                                <td>
                                    @if (item.DiscountedPrice > 0)
                                    {
                                        <del class="text-danger">$@item.Price.ToString("0.00")</del>

                                        <br />
                                        <strong>$@item.DiscountedPrice.ToString("0.00")</strong>
                                    }
                                    else
                                    {
                                        <strong>$@item.Price.ToString("0.00")</strong>
                                    }
                                </td>
                                <td>
                                    @if (item.DiscountedPrice > 0)
                                    {
                                        <del class="text-danger">$@((item.Price * item.Quantity).ToString("0.00"))</del>
                                        <br />
                                        <strong>$@((item.DiscountedPrice * item.Quantity).ToString("0.00"))</strong>
                                    }
                                    else
                                    {
                                        <strong>$@((item.Price * item.Quantity).ToString("0.00"))</strong>
                                    }
                                </td>
                                <td>
                                    @Html.ActionLink("Delete", "Delete", new { /* id=item.PrimaryKey */ })
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h5>Check Out</h5>
                <hr />
                <dl>
                    <dt>Total Price</dt>
                    <dd>$@total_price.ToString("0.00")</dd>
                    <dt>Total Discount</dt>
                    <dd>$@total_discount.ToString("0.00")</dd>
                    <hr />
                    <dt>Total Due</dt>
                    <dd>$@total_due.ToString("0.00")</dd>
                </dl>
                <form asp-action="checkout" asp-controller="home" method="post">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" id="mockpay" name="paymentType" required value="mockpay">
                        <label class="form-check-label" for="mockpay">MockPay</label>
                    </div>
                    <input type="hidden" name="amount" value="@total_due" />
                    <button type="submit" class="btn btn-primary">Check Out Now</button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const changeQty = (btn) => {
            const body = {
                username: "@User.Identity?.Name",
                productId: parseInt(btn.dataset.pid),
                quantity: btn.dataset.direction === 'increment' ? 1 : -1
            }

            fetch("/changequantity",{
                method:"POST",
                headers:{
                    'content-type': 'application/json'
                },
                body: JSON.stringify(body)
            })
            .then(res=>{
                if(!res.ok){
                    throw new Error("Not Ok!")
                }
                location.reload()
            })
            .catch(err => console.error(err))
        }
    </script>
}
